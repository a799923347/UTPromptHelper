## UTPromptHelper - IntelliJ IDEA 插件

> 基于 Git 变更，一键生成“单元测试提示词”的 IntelliJ 插件。

![Build](https://img.shields.io/badge/Gradle-8.1-02303A?logo=gradle) ![JDK](https://img.shields.io/badge/JDK-21-007396?logo=java) ![IDEA](https://img.shields.io/badge/IntelliJ-2024.2+-000000?logo=intellijidea)

— 让 UT 生成更简单、更高效。

### 简介

UTPromptHelper 是一个 IntelliJ IDEA 插件，用于基于 Git 变更自动生成“单元测试提示词”。插件通过对比当前分支与 `master` 的差异，过滤无效变更（导入、包声明、空白、注释、纯“注释化代码”变更），生成结构化的提示词，帮助快速编写高质量单元测试。

### 目录

- [主要功能](#主要功能)
- [安装](#安装)
- [使用指南](#使用指南)
- [页面样式与交互细节](#页面样式与交互细节)
- [系统与构建要求](#系统与构建要求)
- [故障排除（FAQ）](#故障排除faq)
- [开发](#开发)
- [许可证](#许可证)
- [更新日志（摘）](#更新日志摘)

### 主要功能

- **全局变更分析（Tools 菜单）**：扫描非测试目录的 `*.java` 变更，展示每个文件的变更行区间。
- **单文件快捷分析（右键菜单）**：在任意文件上右键一键生成当前文件的提示词。
- **右侧工具栏（Tool Window）入口**：在 IDE 右侧显示 “UTPrompt” 面板，内含两个按钮：
  - 获取UT提示词（全局）：等同 `Tools → 获取UT提示词`
  - 生成UT提示词（当前文件）：等同文件右键菜单
- **智能过滤**：剔除 `import`、`package`、注释和空白；识别“将代码整体改为注释”的 diff，并忽略这类改动。
- **可编辑提示词模板**：内置专业模板，可保存/重置/重新加载；优先读取用户自定义模板。
- **实时预览与复制**：按勾选文件聚合预览，一键复制到剪贴板。
- **Cursor 集成**：支持直接在 Cursor 中打开当前工程（macOS 使用 `open -a Cursor <project>`）。

### 安装

1) 从安装包安装（推荐）

1. 下载 `build/distributions/UTPromptHelper-*.zip`。
2. 打开 IntelliJ IDEA → `Settings` → `Plugins` → 齿轮 → `Install Plugin from Disk...`。
3. 选择 ZIP，安装后重启 IDE。

2) 从源码构建

```bash
cd /Users/zhaobaowen/CaoCaoProjects/UTPromptHelper
export JAVA_HOME=$(/usr/libexec/java_home -v 21)
export GRADLE_USER_HOME=~/.gradle
./gradlew buildPlugin

# 产物位置
open build/distributions
```

如需仅在当前工程使用 JDK 21，可在 `gradle.properties` 增加：

```
org.gradle.java.home=/Users/zhaobaowen/Library/Java/JavaVirtualMachines/azul-21.0.8/Contents/Home
```

> 提示：首次使用前，建议将项目切换到当前分支，确保与 `master` 的差异准确。

### 使用指南

1) Tools 菜单（批量）

- 打开 `Tools → 获取UT提示词`。
- 勾选需要的文件；支持全选/全不选。
- 编辑提示词模板（可选），右侧实时预览聚合内容。
- 点击“复制到剪贴板”或“在 Cursor 中打开”。

2) 右键菜单（单文件）

- 在项目视图或编辑器中右键目标文件 → `生成UT提示词`。
- 自动分析该文件与 `master` 的差异并展示预览与复制选项。

3) 右侧工具栏（Tool Window）

- 打开 IDE 右侧的 “UTPrompt” 面板。
- 点击“获取UT提示词（全局）”或“生成UT提示词（当前文件）”即可触发对应能力。

提示：预览中展示的“变更行区间”已排除导入/注释/空白，以及纯“注释化代码”的变动（避免无效 UT 工作量）。

### 提示词模板

默认模板强调覆盖范围、测试结构、Mock 策略与可运行性，示例开头如下：

```
基于代码库的现有单元测试风格，为以下变更生成单元测试，具体要求：
测试覆盖：确保测试覆盖所有变更的代码行，包括边界条件和异常场景。
测试类创建：优先创建新的测试类，保持与生产代码的包结构一致（例如测试类放在 src/test/java 对应包下）。
测试运行器：优先使用 MockitoJUnitRunner 进行依赖 mock 和测试执行，仅在必要时使用 PowerMockRunner。
Mock 策略：避免过度 mock；只在必要时 mock 静态方法或复杂依赖。
验证与修复：生成测试代码后，检查编译与运行情况，如有问题进行修复以确保可运行。
代码风格：遵循现有测试命名、断言风格与结构（如 @Before 初始化）。
需要覆盖的代码如下：
```

模板配置优先级：用户自定义 > 默认模板。自定义模板持久化位置：`~/.utprompthelper/config.properties`。

### 页面样式与交互细节

- 布局
  - 基于 `DialogWrapper`，主面板采用垂直分区：文件选择区 → 模板编辑区 → 预览区 → 操作区。
  - 文件选择区使用 `BorderLayout` + 垂直 `BoxLayout`，支持长列表滚动；每个文件项左侧为复选框，右侧为等宽字体信息块。
- 字体与可读性
  - 文本采用等宽字体（Monospaced 12pt）呈现路径、行号与模板内容，便于对齐与复制。
  - 文件信息与预览区默认开启自动换行，长行不溢出。
- 间距与边框
  - 分区使用带标题的边框（TitledBorder）区分语义；文件项增加上下内边距，提升密集列表的可读性。
- 滚动区域
  - 文件列表、模板编辑区与预览区均内置滚动容器，适配大规模变更与长模板文本。
- 操作按钮
  - 提供“全选/全不选”便捷批量操作；模板区提供“保存/重置/重新加载”；底部提供“复制到剪贴板/在 Cursor 中打开”。
  - 关键按钮配套图标（如 📋、🚀、💾、🔄、📂）强化视觉辨识。
- 交互反馈
  - 模板/勾选变化触发实时预览刷新；复制成功/模板保存等提供消息提示对话框。
  - 当无选中文件时复制按钮给出友好警示，避免空内容复制。

可选：添加界面截图至 `docs/images/` 并在此处引用（占位示例）

```
![文件选择区](docs/images/file-section.png)
![模板编辑区](docs/images/prompt-section.png)
![预览与复制](docs/images/preview-copy.png)
```

#### 页面样式示意图（ASCII）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             UT提示词助手（Dialog）                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ [文件选择区]                                                                │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ [全选] [全不选]                                                          │ │
│ │ ─────────────────────────────────────────────────────────────────────── │ │
│ │ [☑] src/main/java/com/foo/Bar.java                                      │ │
│ │     变更行数: 2 处 | 位置: 10-15, 25-30                                   │ │
│ │ [☐] src/main/java/com/foo/Baz.java                                      │ │
│ │     变更行数: 1 处 | 位置: 77-80                                         │ │
│ │   ...（可滚动）                                                          │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│ [提示词编辑区]                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ [💾 保存提示词]  [🔄 重置为默认]  [📂 重新加载提示词]                     │ │
│ │ ─────────────────────────────────────────────────────────────────────── │ │
│ │ 基于代码库的现有单元测试风格，为以下变更生成单元测试...                │ │
│ │ （等宽字体，多行文本，可滚动、自动换行）                                 │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│ [预览区（将复制的内容）]                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 基于代码库的现有单元测试风格，为以下变更生成单元测试...                │ │
│ │                                                                         │ │
│ │ src/main/java/com/foo/Bar.java                                          │ │
│ │    变更行数: 2 处                                                       │ │
│ │    具体位置: 10-15, 25-30                                               │ │
│ │   ...（等宽字体，可滚动）                                               │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                                     [📋 复制到剪贴板]   [🚀 在 Cursor 中打开] │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 系统与构建要求

- IntelliJ 平台：`since-build="242.0"`（IDEA 2024.2 及以上）
- JDK：建议 JDK 21（至少 JDK 11）。
- Git：需要一个已初始化的 Git 仓库，且存在 `master` 分支作为比较基线。

### 故障排除（FAQ）

- 构建提示需要 JDK 11+/21：确保 `./gradlew --version` 中 `JVM` 为 11/17/21；可用 `org.gradle.java.home` 项目级绑定。
- 依赖下载失败、`www.jetbrains.com` 连接被拒绝：检查公司代理/hosts；或在 `gradle.properties` 配置 `intellij.localPath` 指向本地已安装的 IDEA 目录以离线构建。
- 未检测到变更：确认当前分支相对 `master` 有差异，且文件在非 `src/test/` 目录下。
- 预览包含无效行段：已内置过滤导入/注释/空白与“注释化代码”，若仍异常，请附示例 diff 反馈。

### 开发

主要代码位置：

- `com.ut.prompt.utprompthelper.GitCompareAction`（全项目变更）
- `com.ut.prompt.utprompthelper.FileBasedPromptAction`（单文件右键）
- `com.ut.prompt.utprompthelper.SimplePromptConfig`（模板持久化与加载）

### 许可证

MIT，详见 `LICENSE`。

### 更新日志（摘）

- v2.4.0：对齐 IDEA 2024.2+；完善交互与构建兼容性。
- v2.2.0：新增右键菜单，UI/逻辑与 Tools 菜单保持一致。
- v1.x：基础 Git 变更检测、模板编辑、预览与 Cursor 集成。

—— 让 UT 生成更简单、更高效。🚀
